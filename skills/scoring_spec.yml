scoring_spec:
  version: "1.3"

  # ============================
  # Core computed metrics
  # ============================
  core_metrics:
    protein_pct:
      formula: protein_g / serving_size_g

    protein_per_100_kcal:
      formula: protein_g / energy_kcal * 100

    eaas_pct_raw:
      formula: eaas_g / protein_g

    eaas_pct:
      formula: min(eaas_pct_raw, 1.0)

    bcaas_pct_of_eaas:
      formula: bcaas_g / eaas_g

    non_protein_macros_g:
      formula: carbohydrates_g + total_fat_g

    leucine_g_per_serving:
      formula: leucine_g

  # ============================
  # Normalization ranges
  # (all scores âˆˆ [0,1])
  # ============================
  normalization_ranges:
    protein_pct:
      "<65": 0.0
      "65-72": 0.5
      "72-80": 0.8
      ">80": 1.0

    protein_per_100_kcal:
      "<18": 0.0
      "18-22": 0.6
      "22-26": 0.85
      ">26": 1.0

    leucine_g_per_serving:
      "<2.2": 0.0
      "2.2-2.7": 0.7
      ">=2.7": 1.0

    eaas_pct:
      "<40%": 0.0
      "40-45%": 0.7
      ">45%": 1.0

    # Used ONLY in CLEAN mode as positive signals
    sodium_mg:
      "<100": 1.0
      "100-200": 0.6
      "200-250": 0.3
      ">250": 0.0

    non_protein_macros_g:
      "<4": 1.0
      "4-6": 0.6
      "6-8": 0.3
      ">8": 0.0

  # ============================
  # Penalties (deductions)
  # Used ONLY in CUT & BULK
  # ============================
  penalties:
    sodium_mg:
      "<100": 0.0
      "100-200": 0.3
      ">200": 0.6

    non_protein_macros_g:
      "<4": 0.0
      "4-6": 0.2
      ">6": 0.5

  # ============================
  # Amino spiking detection
  # ============================
  amino_spiking_detection:
    rules:
      glycine_disproportion:
        condition: glycine_g / protein_g > 0.05

      low_eaas:
        condition: eaas_pct < 0.40

      bcaas_dominant:
        condition: bcaas_pct_of_eaas > 0.60

      eaas_exceed_protein:
        condition: eaas_pct_raw > 1.0

    trigger:
      type: threshold
      min_rules_required: 2

    output_flag: amino_spiking_suspected

  # ============================
  # Mode-specific scoring
  # ============================
  modes:
    cut:
      hard_reject:
        protein_per_100_kcal: "<18"
        leucine_g_per_serving: "<2.2"

      weights:   # SUM = 1.0
        protein_per_100_kcal: 0.40
        leucine_g_per_serving: 0.30
        protein_pct: 0.20
        eaas_pct: 0.10

      penalty_weights:
        sodium_mg: 0.10
        non_protein_macros_g: 0.15

    bulk:
      hard_reject: {}

      weights:   # SUM = 1.0
        protein_pct: 0.35
        eaas_pct: 0.30
        leucine_g_per_serving: 0.25
        protein_g_per_serving: 0.10

      penalty_weights:
        sodium_mg: 0.05
        non_protein_macros_g: 0.05

      value_adjusted: true

    clean:
      hard_reject:
        sodium_mg: ">250"
        added_sugar_present: true
        amino_spiking_suspected: true

      weights:   # SUM = 1.0
        sodium_mg: 0.35
        non_protein_macros_g: 0.30
        eaas_pct: 0.15
        leucine_g_per_serving: 0.10
        protein_pct: 0.10